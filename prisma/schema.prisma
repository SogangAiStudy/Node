generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String          @id @default(cuid())
  name               String?
  email              String          @unique
  image              String?
  createdAt          DateTime        @default(now())
  emailVerified      DateTime?
  accounts           Account[]
  activityLogs       ActivityLog[]
  ownedNodes         Node[]          @relation("NodeOwner")
  orgMemberships     OrgMember[]
  ownedOrganizations Organization[]  @relation("OrganizationOwner")
  projectMemberships ProjectMember[]
  ownedProjects      Project[]       @relation("ProjectOwner")
  approvedRequests   Request[]       @relation("RequestApprover")
  createdRequests    Request[]       @relation("RequestCreator")
  assignedRequests   Request[]       @relation("RequestAssignee")
  sessions           Session[]
  teamMemberships    TeamMember[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id           String        @id @default(cuid())
  name         String
  inviteCode   String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  ownerId      String
  activityLogs ActivityLog[]
  edges        Edge[]
  nodes        Node[]
  members      OrgMember[]
  owner        User          @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  projects     Project[]
  requests     Request[]
  teams        Team[]

  @@index([ownerId])
  @@map("organizations")
}

model OrgMember {
  id           String          @id @default(cuid())
  orgId        String
  userId       String
  role         OrgRole         @default(MEMBER)
  status       OrgMemberStatus @default(PENDING_TEAM_ASSIGNMENT)
  createdAt    DateTime        @default(now())
  organization Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@map("org_members")
}

model Team {
  id              String        @id @default(cuid())
  orgId           String
  name            String
  description     String?
  createdAt       DateTime      @default(now())
  nodes           Node[]
  projectTeams    ProjectTeam[]
  primaryProjects Project[]     @relation("PrimaryTeam")
  members         TeamMember[]
  organization    Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  orgId     String
  teamId    String
  userId    String
  role      TeamRole @default(MEMBER)
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model ProjectTeam {
  id        String      @id @default(cuid())
  orgId     String
  projectId String
  teamId    String
  role      ProjectRole @default(VIEWER)
  createdAt DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team      Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([projectId, teamId])
  @@index([projectId])
  @@index([teamId])
  @@map("project_teams")
}

model Project {
  id            String          @id @default(cuid())
  name          String
  createdAt     DateTime        @default(now())
  description   String?
  orgId         String
  primaryTeamId String?
  updatedAt     DateTime        @updatedAt
  ownerId       String
  activityLogs  ActivityLog[]
  edges         Edge[]
  nodes         Node[]
  members       ProjectMember[]
  projectTeams  ProjectTeam[]
  organization  Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  owner         User            @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  primaryTeam   Team?           @relation("PrimaryTeam", fields: [primaryTeamId], references: [id])
  requests      Request[]

  @@index([orgId])
  @@index([ownerId])
  @@index([primaryTeamId])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  team      String?
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Node {
  id             String       @id @default(cuid())
  projectId      String
  title          String
  description    String?
  type           NodeType     @default(TASK)
  manualStatus   ManualStatus @default(TODO)
  ownerId        String?
  priority       Int          @default(3)
  dueAt          DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  orgId          String
  teamId         String?
  edgesFrom      Edge[]       @relation("EdgeFrom")
  edgesTo        Edge[]       @relation("EdgeTo")
  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  owner          User?        @relation("NodeOwner", fields: [ownerId], references: [id])
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team           Team?        @relation(fields: [teamId], references: [id])
  linkedRequests Request[]

  @@index([orgId])
  @@index([projectId])
  @@index([teamId])
  @@index([ownerId])
  @@map("nodes")
}

model Edge {
  id           String       @id @default(cuid())
  projectId    String
  fromNodeId   String
  toNodeId     String
  relation     EdgeRelation
  createdAt    DateTime     @default(now())
  orgId        String
  fromNode     Node         @relation("EdgeFrom", fields: [fromNodeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  toNode       Node         @relation("EdgeTo", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([projectId, fromNodeId, toNodeId, relation])
  @@index([orgId])
  @@index([projectId])
  @@index([fromNodeId])
  @@index([toNodeId])
  @@map("edges")
}

model Request {
  id            String        @id @default(cuid())
  projectId     String
  linkedNodeId  String
  question      String
  fromUserId    String
  toUserId      String?
  toTeam        String?
  status        RequestStatus @default(OPEN)
  responseDraft String?
  responseFinal String?
  approvedById  String?
  approvedAt    DateTime?
  claimedAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  orgId         String
  approvedBy    User?         @relation("RequestApprover", fields: [approvedById], references: [id])
  fromUser      User          @relation("RequestCreator", fields: [fromUserId], references: [id], onDelete: Cascade)
  linkedNode    Node          @relation(fields: [linkedNodeId], references: [id], onDelete: Cascade)
  organization  Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  toUser        User?         @relation("RequestAssignee", fields: [toUserId], references: [id])

  @@index([orgId])
  @@index([projectId])
  @@index([linkedNodeId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@map("requests")
}

model ActivityLog {
  id           String       @id @default(cuid())
  projectId    String
  userId       String
  action       String
  entityType   String
  entityId     String
  details      Json?
  createdAt    DateTime     @default(now())
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

enum OrgRole {
  ADMIN
  MEMBER
}

enum OrgMemberStatus {
  ACTIVE
  PENDING_TEAM_ASSIGNMENT
  DEACTIVATED
  PENDING_APPROVAL
}

enum TeamRole {
  LEAD
  MEMBER
}

enum ProjectRole {
  PROJECT_ADMIN
  EDITOR
  VIEWER
}

enum NodeType {
  TASK
  DECISION
  BLOCKER
  INFOREQ
}

enum ManualStatus {
  TODO
  DOING
  DONE
}

enum EdgeRelation {
  DEPENDS_ON
  HANDOFF_TO
  NEEDS_INFO_FROM
  APPROVAL_BY
}

enum RequestStatus {
  OPEN
  RESPONDED
  APPROVED
  CLOSED
}
